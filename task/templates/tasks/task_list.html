{% extends "base.html" %}
{% load static %}
 
{% block content %} 
<style>

    .after-header {
    margin-top: 120px;
    }

</style>


<section class="section after-header" id="task-section">
  <div class="container">
    <div class="row mb-4">
      <div class="col-lg-12 text-center">
        <h2>Все Задания и Челленджи</h2>
        <p class="text-muted">Выбери интересное задание или челлендж и попробуй выполнить его прямо сейчас!</p>
      </div>
    </div>


    <!-- Фильтрация по категориям (если нужно) -->
    <div class="row mb-4">
      <div class="col-md-5">
        <select id="category-filter" class="form-select">
          <option value="">Все категории</option>
        </select>
      </div>
      <div class="col-md-5">
        <select id="difficulty-filter" class="form-select">
          <option value="">Любая сложность</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100" onclick="loadTasks()">Фильтровать</button>
      </div>
    </div>

    <!-- Список заданий -->
    <div class="row" id="task-container">
      <p>Загрузка заданий...</p>
    </div>
  </div>
</section>

<!-- Скрипт для загрузки задач с API -->
<script>
  async function loadTasks() {
    const cat = document.getElementById("category-filter").value;
    const diff = document.getElementById("difficulty-filter").value;
    let url = "/tasks/";

    const params = [];
    if (cat) params.push(`category=${cat}`);
    if (diff) params.push(`difficulty=${diff}`);
    if (params.length > 0) url += `?${params.join('&')}`;

    const res = await fetch(url);
    const data = await res.json();
    const container = document.getElementById("task-container");
    container.innerHTML = "";

    if (data.length === 0) {
      container.innerHTML = "<p>Ничего не найдено по фильтрам.</p>";
    }

    data.forEach(task => {
      const div = document.createElement("div");
      div.classList.add("col-md-6", "mb-4");

      div.innerHTML = `
        <div class="card shadow p-3">
          <h5>${task.title}</h5>
          <p><strong>Категория:</strong> ${task.category}</p>
          <p><strong>Ответ:</strong> ${task.answer || "—"}</p>
        </div>
      `;
      container.appendChild(div);
    });
  }

  async function loadFilters() {
    const catRes = await fetch('/categories/');
    const categories = await catRes.json();
    const catSelect = document.getElementById('category-filter');
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.id;
      opt.textContent = cat.name;
      catSelect.appendChild(opt);
    });

    const diffRes = await fetch('/difficulties/');
    const diffs = await diffRes.json();
    const diffSelect = document.getElementById('difficulty-filter');
    diffs.forEach(diff => {
      const opt = document.createElement('option');
      opt.value = diff.id;
      opt.textContent = diff.level;
      diffSelect.appendChild(opt);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadFilters().then(loadTasks);
  });
</script>
{% endblock %}
